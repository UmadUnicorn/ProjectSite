{% extends 'core/base.html' %}
{% load project_filters %}

{% block title %}–û—Ç—á—ë—Ç –ø–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é{% endblock %}

{% block content %}
<h2>–û—Ç—á—ë—Ç: {{ event.date|date:"d E Y H:i" }} ‚Äî {{ event.name }}</h2>

<button class="btn" id="toggle-header-button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫</button>

<div id="header-form-wrapper" class="passport-wrapper" style="margin-top: 10px;">
    <form method="post">
        {% csrf_token %}
        {{ header_form.as_p }}
        <button class="btn" type="submit" name="edit_header">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫</button>
    </form>
</div>

<!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ç—Ä–∏–∫ -->
<form method="post" id="metrics-form">
    {% csrf_token %}
    <table class="metrics-table">
        <thead>
            <tr>
                <th>–ú–µ—Ç—Ä–∏–∫–∞</th>
                <th>–¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                <th>–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
            </tr>
        </thead>
        <tbody>
            {% for metric in metrics %}
            <tr>
                <td>{{ metric.name }}</td>
                <td>{{ metric.target }}</td>
                <td>
                    <input type="text" name="fact_{{ forloop.counter0 }}" value="{{ actual_values|get_item:metric.name }}">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {{ form }}  {# —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ actual_metrics #}
    <button class="btn save-button" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫</button>
</form>

<hr>

{% if can_edit_metrics %}
<h3>üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ photo_form.as_p }}
    <button class="btn" type="submit" name="upload_photo">‚ûï –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
</form>
{% endif %}

{% if photos %}
<h3>üñº –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</h3>
<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
    {% for photo in photos %}
        <div>
            <img src="{{ photo.image.url }}" alt="–§–æ—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è" style="max-width: 200px; max-height: 150px; border: 1px solid #ccc; border-radius: 5px;">
        </div>
    {% endfor %}
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* ---------- —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ/—Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –∑–∞–≥–æ–ª–æ–≤–∫–∞ ---------- */
    const toggleBtn = document.getElementById('toggle-header-button');
    const wrapper   = document.getElementById('header-form-wrapper');

    if (toggleBtn && wrapper) {
        toggleBtn.addEventListener('click', () => {
            wrapper.classList.toggle('open');
        });
    }

    /* ---------- —É–ø–∞–∫–æ–≤–∫–∞ –º–µ—Ç—Ä–∏–∫ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ---------- */
    const form        = document.getElementById('metrics-form');
    const hiddenField = document.getElementById('id_actual_metrics');

    if (form && hiddenField) {
        form.addEventListener('submit', () => {
            const data = {};
            {% for metric in metrics %}
                data["{{ metric.name|escapejs }}"] =
                    document.querySelector('[name="fact_{{ forloop.counter0 }}"]').value;
            {% endfor %}
            hiddenField.value = JSON.stringify(data);
        });
    }

});
</script>
{% endblock %}
